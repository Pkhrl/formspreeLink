<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .video-container { 
            position: relative; 
            width: 100%; 
            padding-top: 75%; /* 4:3 Aspect Ratio for better scanning */
            background-color: #1f2937; 
            overflow: hidden; 
            border-radius: 1.5rem; 
        }
        video { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); /* Mirror effect */ 
        }
        .camera-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #9ca3af;
        }
        .button { 
            transition: all 0.2s ease-in-out; 
        }
        .button:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }
        .status-scanned { 
            background-color: #10b981; 
            color: white; 
        }
        .status-pending { 
            background-color: #4b5563; 
            color: #d1d5db; 
        }
        .reset-btn { 
            background-color: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .reset-btn:hover { 
            background-color: #2563eb; 
        }
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #10b981;
            border-radius: 12px;
            opacity: 0.8;
            pointer-events: none;
        }
        .scan-corners::before,
        .scan-corners::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #10b981;
        }
        .scan-corners::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }
        .scan-corners::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .scanning-animation {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto p-6 bg-gray-800 rounded-3xl shadow-lg border border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-2 text-yellow-400">Ticket Scanner</h1>
        <p class="text-center text-sm text-gray-400 mb-6">Scan QR codes to validate tickets and prevent duplicates.</p>

        <!-- Camera Permission Notice -->
        <div id="permission-notice" class="bg-blue-800 border border-blue-600 rounded-lg p-4 mb-4 hidden">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-200">
                        Camera permission is required for scanning. Please allow camera access when prompted.
                    </p>
                </div>
            </div>
        </div>

        <div class="video-container mb-6 border-4 border-gray-700 rounded-3xl overflow-hidden">
            <video id="qr-video"></video>
            <div id="camera-placeholder" class="camera-placeholder">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <p class="text-sm">Camera will appear here</p>
            </div>
            <div id="scan-overlay" class="scan-overlay scan-corners hidden"></div>
        </div>

        <div class="text-center mb-6 h-16 flex flex-col justify-center">
            <p id="result-text" class="text-xl font-semibold mb-1"></p>
            <p id="status-text" class="text-sm font-medium text-gray-400">Ready to scan.</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="start-button" class="button w-full bg-green-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-green-700">
                <span id="start-text">Start Scan</span>
                <span id="start-loading" class="hidden">Starting...</span>
            </button>
            <button id="stop-button" class="button w-full bg-red-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-red-700" disabled>Stop Scan</button>
        </div>

        <!-- Camera Help Section -->
        <div id="camera-help" class="bg-gray-700 border border-gray-600 rounded-lg p-4 mb-6 hidden">
            <h3 class="text-lg font-semibold text-yellow-400 mb-2">Camera Not Working?</h3>
            <div class="text-sm text-gray-300 space-y-2">
                <p><strong>If the browser doesn't ask for permission:</strong></p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>Look for a camera icon in your address bar and click it</li>
                    <li>Make sure you're using HTTPS (secure connection)</li>
                    <li>Try refreshing the page and clicking "Start Scan" again</li>
                    <li>Check if another app is using your camera</li>
                </ul>
                <p class="mt-3"><strong>Manual permission setup:</strong></p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>Chrome: Click the lock icon → Camera → Allow</li>
                    <li>Firefox: Click the shield icon → Permissions</li>
                    <li>Safari: Safari menu → Preferences → Websites → Camera</li>
                </ul>
                <button id="retry-camera" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    Try Again
                </button>
            </div>
        </div>

        <div class="bg-gray-700 p-6 rounded-2xl border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">Ticket Status</h2>
                <div class="flex items-center space-x-4">
                    <p id="scan-summary" class="font-semibold text-gray-300"></p>
                    <button id="reset-all" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded-lg text-xs font-medium transition">
                        Reset All
                    </button>
                </div>
            </div>
            <div id="ticket-list" class="space-y-2 max-h-48 overflow-y-auto">
            </div>
        </div>
        
        <!-- Modal -->
        <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen px-4 text-center">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-900 opacity-75"></div>
                </div>
                <div class="inline-block bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full border border-gray-600">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="flex items-center">
                            <div id="modal-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center">
                                <!-- Icon will be inserted here -->
                            </div>
                            <div class="ml-3">
                                <h3 id="modal-title" class="text-lg leading-6 font-medium text-white"></h3>
                                <div class="mt-2">
                                    <p id="modal-message" class="text-sm text-gray-300"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button id="modal-close" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.min.js"></script>
    <script>
        const MASTER_VALID_CODES = [
            'TICKET-A123-B456', 'TICKET-C789-D012', 'TICKET-E345-F678',
            'TICKET-G901-H234', 'TICKET-I567-J890', 'https://special-event.com/ticket/unique-id-9876'
        ];

        // DOM Elements
        const qrVideo = document.getElementById('qr-video');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const resultText = document.getElementById('result-text');
        const statusText = document.getElementById('status-text');
        const ticketListContainer = document.getElementById('ticket-list');
        const scanSummary = document.getElementById('scan-summary');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const scanOverlay = document.getElementById('scan-overlay');
        const permissionNotice = document.getElementById('permission-notice');
        const cameraHelp = document.getElementById('camera-help');
        const retryCamera = document.getElementById('retry-camera');
        const resetAllButton = document.getElementById('reset-all');
        const startText = document.getElementById('start-text');
        const startLoading = document.getElementById('start-loading');

        let qrScanner = null;
        let isScanning = false;
        let scannedCodes = {};
        let cameraPermissionDenied = false;

        function showAlert(title, message, type = 'info') {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            
            // Set icon based on type
            const modalIcon = document.getElementById('modal-icon');
            modalIcon.innerHTML = '';
            
            if (type === 'error') {
                modalIcon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center';
                modalIcon.innerHTML = '<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            } else if (type === 'success') {
                modalIcon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center';
                modalIcon.innerHTML = '<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else {
                modalIcon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center';
                modalIcon.innerHTML = '<svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            document.getElementById('modal').classList.remove('hidden');
        }

        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('modal').classList.add('hidden');
        });

        function initializeTicketState() {
            scannedCodes = {};
            MASTER_VALID_CODES.forEach(code => {
                scannedCodes[code] = { scanned: false, timestamp: null };
            });
            updateTicketListUI();
        }

        function updateTicketListUI() {
            ticketListContainer.innerHTML = '';
            let scannedCount = 0;
            const totalCount = MASTER_VALID_CODES.length;

            for (const code in scannedCodes) {
                const ticketData = scannedCodes[code];
                const isScanned = ticketData.scanned;
                if (isScanned) scannedCount++;

                const li = document.createElement('div');
                li.className = 'flex items-center justify-between bg-gray-800 rounded-lg p-3 transition-all hover:bg-gray-750';
                
                const leftSection = document.createElement('div');
                leftSection.className = 'flex-1 min-w-0';
                
                const codeText = document.createElement('span');
                codeText.textContent = code;
                codeText.className = 'block truncate text-sm font-medium';
                
                leftSection.appendChild(codeText);
                
                if (isScanned && ticketData.timestamp) {
                    const timeText = document.createElement('span');
                    timeText.textContent = new Date(ticketData.timestamp).toLocaleTimeString();
                    timeText.className = 'block text-xs text-gray-400';
                    leftSection.appendChild(timeText);
                }

                const controlsWrapper = document.createElement('div');
                controlsWrapper.className = 'flex items-center space-x-3 flex-shrink-0';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge ' + (isScanned ? 'status-scanned' : 'status-pending');
                statusBadge.textContent = isScanned ? 'Scanned ✔️' : 'Pending';

                controlsWrapper.appendChild(statusBadge);

                if (isScanned) {
                    const resetButton = document.createElement('button');
                    resetButton.innerHTML = '&#8635;';
                    resetButton.className = 'reset-btn';
                    resetButton.title = 'Reset this ticket';
                    resetButton.dataset.code = code;
                    controlsWrapper.appendChild(resetButton);
                }

                li.appendChild(leftSection);
                li.appendChild(controlsWrapper);
                ticketListContainer.appendChild(li);
            }
            
            scanSummary.textContent = `${scannedCount} / ${totalCount} Scanned`;
            
            // Show/hide reset all button
            resetAllButton.style.display = scannedCount > 0 ? 'block' : 'none';
        }

        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                // Stop the stream immediately, we just wanted to test permission
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('Camera permission error:', error);
                cameraPermissionDenied = true;
                return false;
            }
        }

        async function startScanner() {
            if (isScanning) return;

            // Show loading state
            startText.classList.add('hidden');
            startLoading.classList.remove('hidden');
            startButton.disabled = true;
            
            // Show permission notice
            permissionNotice.classList.remove('hidden');
            statusText.textContent = 'Requesting camera access...';
            
            try {
                // Check if we're on HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    throw new Error('Camera requires HTTPS connection');
                }

                // First request permission explicitly
                const hasPermission = await requestCameraPermission();
                if (!hasPermission) {
                    throw new Error('Camera permission denied');
                }

                // Hide permission notice
                permissionNotice.classList.add('hidden');
                cameraHelp.classList.add('hidden');
                
                statusText.textContent = 'Starting camera...';
                
                // Initialize QR Scanner
                qrScanner = new QrScanner(
                    qrVideo,
                    result => handleScanResult(result.data),
                    { 
                        highlightScanRegion: false, // We'll use our own overlay
                        highlightCodeOutline: true,
                        maxScansPerSecond: 5,
                        preferredCamera: 'environment'
                    }
                );

                await qrScanner.start();
                
                // Hide placeholder, show video and overlay
                cameraPlaceholder.classList.add('hidden');
                scanOverlay.classList.remove('hidden');
                scanOverlay.classList.add('scanning-animation');
                
                isScanning = true;
                cameraPermissionDenied = false;
                statusText.textContent = 'Scanning for QR codes...';
                resultText.textContent = '';
                
                stopButton.disabled = false;
                
            } catch (error) {
                console.error('Failed to start scanner:', error);
                
                let errorMessage = 'Could not start camera. ';
                if (error.message.includes('permission')) {
                    errorMessage += 'Camera permission was denied.';
                } else if (error.message.includes('HTTPS')) {
                    errorMessage += 'This site needs to be served over HTTPS for camera access.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotAllowedError') {
                    errorMessage += 'Camera permission denied by user.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Camera is already in use by another application.';
                } else {
                    errorMessage += 'Please check your camera permissions and try again.';
                }
                
                statusText.textContent = 'Camera error occurred.';
                showAlert('Camera Error', errorMessage, 'error');
                
                // Show help section
                cameraHelp.classList.remove('hidden');
                permissionNotice.classList.add('hidden');
                
                stopScanner();
            } finally {
                // Reset button state
                startText.classList.remove('hidden');
                startLoading.classList.add('hidden');
                startButton.disabled = false;
            }
        }

        function stopScanner() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
            }
            
            isScanning = false;
            statusText.textContent = 'Scanner stopped.';
            
            // Show placeholder, hide video overlay
            cameraPlaceholder.classList.remove('hidden');
            scanOverlay.classList.add('hidden');
            scanOverlay.classList.remove('scanning-animation');
            
            startButton.disabled = false;
            stopButton.disabled = true;
            
            // Reset button text
            startText.classList.remove('hidden');
            startLoading.classList.add('hidden');
        }

        function handleScanResult(scannedValue) {
            console.log('Scanned:', scannedValue);
            
            if (scannedCodes.hasOwnProperty(scannedValue)) {
                if (scannedCodes[scannedValue].scanned) {
                    resultText.textContent = 'Duplicate Ticket ❌';
                    resultText.className = 'text-xl font-bold mb-1 text-orange-500';
                    showAlert('Duplicate Ticket', 'This ticket has already been scanned!', 'error');
                } else {
                    resultText.textContent = 'Valid Ticket ✅';
                    resultText.className = 'text-xl font-bold mb-1 text-green-500';
                    scannedCodes[scannedValue].scanned = true;
                    scannedCodes[scannedValue].timestamp = Date.now();
                    updateTicketListUI();
                    
                    // Vibrate on success (if supported)
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                }
            } else {
                resultText.textContent = 'Invalid Ticket 🚫';
                resultText.className = 'text-xl font-bold mb-1 text-red-500';
                showAlert('Invalid Ticket', 'This QR code is not a valid ticket for this event.', 'error');
            }
            
            // Pause scanning briefly to show result
            if (qrScanner && isScanning) {
                qrScanner.pause();
                setTimeout(() => {
                    if (isScanning && qrScanner) {
                        resultText.textContent = '';
                        qrScanner.start().catch(e => console.error('Resume error:', e));
                    }
                }, 2000);
            }
        }

        // Event Listeners
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);
        retryCamera.addEventListener('click', startScanner);

        // Reset individual tickets
        ticketListContainer.addEventListener('click', function(event) {
            const target = event.target;
            if (target && target.classList.contains('reset-btn')) {
                const codeToReset = target.dataset.code;
                if (codeToReset && scannedCodes.hasOwnProperty(codeToReset)) {
                    scannedCodes[codeToReset].scanned = false;
                    scannedCodes[codeToReset].timestamp = null;
                    updateTicketListUI();
                }
            }
        });

        // Reset all tickets
        resetAllButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all scanned tickets?')) {
                initializeTicketState();
                showAlert('Reset Complete', 'All tickets have been reset to pending status.', 'success');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !event.target.matches('input, textarea, button')) {
                event.preventDefault();
                if (isScanning) {
                    stopScanner();
                } else {
                    startScanner();
                }
            }
        });

        // Initialize app
        window.onload = function() {
            console.log('App initialized');
            initializeTicketState();
            stopButton.disabled = true;
            
            // Check if we're on a secure connection
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showAlert('Security Warning', 'Camera access requires a secure (HTTPS) connection. This may not work on HTTP.', 'error');
            }
        };

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isScanning) {
                // Page hidden, pause scanner
                if (qrScanner) {
                    qrScanner.pause();
                }
            } else if (!document.hidden && isScanning) {
                // Page visible again, resume scanner
                if (qrScanner) {
                    qrScanner.start().catch(e => console.error('Resume error:', e));
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .video-container { position: relative; width: 100%; padding-top: 100%; /* 1:1 Aspect Ratio */ background-color: #000; overflow: hidden; border-radius: 1.5rem; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* Mirror effect */ }
        .button { transition: all 0.2s ease-in-out; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-scanned { background-color: #10b981; color: white; }
        .status-pending { background-color: #4b5563; color: #d1d5db; }
        .reset-btn { background-color: #3b82f6; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .reset-btn:hover { background-color: #2563eb; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto p-6 bg-gray-800 rounded-3xl shadow-lg border border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-2 text-yellow-400">Ticket Scanner</h1>
        <p class="text-center text-sm text-gray-400 mb-6">Scan QR codes to validate tickets and prevent duplicates.</p>

        <div class="video-container mb-6 border-4 border-gray-700 rounded-3xl overflow-hidden">
            <video id="qr-video"></video>
        </div>

        <div class="text-center mb-6 h-16 flex flex-col justify-center">
            <p id="result-text" class="text-xl font-semibold mb-1"></p>
            <p id="status-text" class="text-sm font-medium text-gray-400">Ready to scan.</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button id="start-button" class="button w-full bg-green-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-green-700">Start Scan</button>
            <button id="stop-button" class="button w-full bg-red-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-red-700">Stop Scan</button>
        </div>

        <div class="bg-gray-700 p-6 rounded-2xl border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">Ticket Status</h2>
                <p id="scan-summary" class="font-semibold text-gray-300"></p>
            </div>
            <div id="ticket-list" class="space-y-2 max-h-48 overflow-y-auto">
                </div>
        </div>
        
        <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen px-4 text-center">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-900 opacity-75"></div></div>
                <div class="inline-block bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full border border-gray-600">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 id="modal-title" class="text-lg leading-6 font-medium text-white"></h3><div class="mt-2"><p id="modal-message" class="text-sm text-gray-300"></p></div></div>
                    <div class="bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button id="modal-close" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">OK</button></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js"></script>
    <script>
        const MASTER_VALID_CODES = [
            'TICKET-A123-B456', 'TICKET-C789-D012', 'TICKET-E345-F678',
            'TICKET-G901-H234', 'TICKET-I567-J890', 'https://special-event.com/ticket/unique-id-9876'
        ];

        const qrVideo = document.getElementById('qr-video');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const resultText = document.getElementById('result-text');
        const statusText = document.getElementById('status-text');
        const ticketListContainer = document.getElementById('ticket-list');
        const scanSummary = document.getElementById('scan-summary');

        let qrScanner = null;
        let isScanning = false;
        let scannedCodes = {};

        function showAlert(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal').classList.remove('hidden');
        }
        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('modal').classList.add('hidden');
        });

        function initializeTicketState() {
            scannedCodes = {};
            MASTER_VALID_CODES.forEach(code => {
                scannedCodes[code] = { scanned: false };
            });
            updateTicketListUI();
        }

        function updateTicketListUI() {
            ticketListContainer.innerHTML = '';
            let scannedCount = 0;
            const totalCount = MASTER_VALID_CODES.length;

            for (const code in scannedCodes) {
                const isScanned = scannedCodes[code].scanned;
                if (isScanned) scannedCount++;

                const li = document.createElement('div');
                li.className = 'flex items-center justify-between bg-gray-800 rounded-lg p-3';
                
                const codeText = document.createElement('span');
                codeText.textContent = code;
                codeText.className = 'truncate pr-2';

                const controlsWrapper = document.createElement('div');
                controlsWrapper.className = 'flex items-center space-x-3 flex-shrink-0';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge ' + (isScanned ? 'status-scanned' : 'status-pending');
                statusBadge.textContent = isScanned ? 'Scanned ✔️' : 'Pending';

                controlsWrapper.appendChild(statusBadge);

                // **NEW**: Add a reset button for each ticket
                if (isScanned) {
                    const resetButton = document.createElement('button');
                    resetButton.innerHTML = '&#8635;'; // Refresh symbol
                    resetButton.className = 'reset-btn';
                    resetButton.title = 'Reset this ticket';
                    resetButton.dataset.code = code; // Store the code in a data attribute
                    controlsWrapper.appendChild(resetButton);
                }

                li.appendChild(codeText);
                li.appendChild(controlsWrapper);
                ticketListContainer.appendChild(li);
            }
            scanSummary.textContent = `${scannedCount} / ${totalCount} Scanned`;
        }

        async function startScanner() {
            if (window.location.protocol !== 'https:') {
                showAlert('Insecure Connection', 'Camera access requires a secure (HTTPS) connection. You seem to be on HTTPS, so please check browser permissions.');
                statusText.textContent = "Error: Check Permissions";
                return;
            }
            try {
                if (isScanning) return;
                statusText.textContent = 'Starting camera...';
                qrScanner = new QrScanner(
                    qrVideo,
                    result => handleScanResult(result.data),
                    { highlightScanRegion: true, highlightCodeOutline: true }
                );
                await qrScanner.start();
                isScanning = true;
                statusText.textContent = 'Scanning for QR codes...';
                resultText.textContent = '';
                startButton.disabled = true; stopButton.disabled = false;
            } catch (error) {
                console.error('Failed to start scanner:', error);
                statusText.textContent = 'Failed to start camera.';
                showAlert('Camera Error', 'Could not access the camera. Please follow the steps to grant camera permissions in your browser settings for this site and reload the page.');
                stopScanner();
            }
        }

        function stopScanner() {
            if (qrScanner) {
                qrScanner.stop(); qrScanner.destroy(); qrScanner = null;
            }
            isScanning = false;
            statusText.textContent = 'Scanner stopped.';
            startButton.disabled = false; stopButton.disabled = true;
        }

        function handleScanResult(scannedValue) {
            if (scannedCodes.hasOwnProperty(scannedValue)) {
                if (scannedCodes[scannedValue].scanned) {
                    resultText.textContent = 'Duplicate Ticket ❌';
                    resultText.className = 'text-xl font-bold mb-1 text-orange-500';
                } else {
                    resultText.textContent = 'Valid Ticket ✅';
                    resultText.className = 'text-xl font-bold mb-1 text-green-500';
                    scannedCodes[scannedValue].scanned = true;
                    updateTicketListUI();
                }
            } else {
                resultText.textContent = 'Invalid Ticket 🚫';
                resultText.className = 'text-xl font-bold mb-1 text-red-500';
            }
            
            qrScanner.pause();
            setTimeout(() => {
                if(isScanning) {
                    resultText.textContent = '';
                    qrScanner.start().catch(e => console.error(e));
                }
            }, 2000);
        }

        // **NEW**: Event listener for handling clicks on the per-ticket reset buttons
        ticketListContainer.addEventListener('click', function(event) {
            const target = event.target;
            // Check if a reset button was clicked
            if (target && target.classList.contains('reset-btn')) {
                const codeToReset = target.dataset.code;
                if (codeToReset && scannedCodes.hasOwnProperty(codeToReset)) {
                    scannedCodes[codeToReset].scanned = false;
                    updateTicketListUI(); // Re-render the list to reflect the change
                }
            }
        });

        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        window.onload = function() {
            initializeTicketState();
            stopButton.disabled = true;
        };
    </script>
</body>
</html>
